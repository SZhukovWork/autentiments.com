id: 80
source: 1
name: PolylangSitemap
category: Polylang
properties: 'a:25:{s:5:"cache";a:9:{s:4:"name";s:5:"cache";s:4:"desc";s:19:"polylang_prop_cache";s:4:"type";s:13:"combo-boolean";s:7:"options";a:0:{}s:5:"value";b:1;s:7:"lexicon";s:19:"polylang:properties";s:4:"area";s:0:"";s:10:"desc_trans";s:76:"Кэширование результатов работы сниппета.";s:10:"area_trans";s:0:"";}s:8:"cacheKey";a:9:{s:4:"name";s:8:"cacheKey";s:4:"desc";s:22:"polylang_prop_cacheKey";s:4:"type";s:9:"textfield";s:7:"options";a:0:{}s:5:"value";s:0:"";s:7:"lexicon";s:19:"polylang:properties";s:4:"area";s:0:"";s:10:"desc_trans";s:41:"Имя ключа кэширования.";s:10:"area_trans";s:0:"";}s:9:"cacheTime";a:9:{s:4:"name";s:9:"cacheTime";s:4:"desc";s:23:"pdotools_prop_cacheTime";s:4:"type";s:11:"numberfield";s:7:"options";a:0:{}s:5:"value";i:600;s:7:"lexicon";s:19:"pdotools:properties";s:4:"area";s:0:"";s:10:"desc_trans";s:65:"Время актуальности кэша в секундах.";s:10:"area_trans";s:0:"";}s:7:"context";a:9:{s:4:"name";s:7:"context";s:4:"desc";s:21:"polylang_prop_context";s:4:"type";s:9:"textfield";s:7:"options";a:0:{}s:5:"value";s:0:"";s:7:"lexicon";s:19:"polylang:properties";s:4:"area";s:0:"";s:10:"desc_trans";s:79:"Ограничение выборки по контексту ресурсов.";s:10:"area_trans";s:0:"";}s:5:"depth";a:9:{s:4:"name";s:5:"depth";s:4:"desc";s:19:"polylang_prop_depth";s:4:"type";s:11:"numberfield";s:7:"options";a:0:{}s:5:"value";i:10;s:7:"lexicon";s:19:"polylang:properties";s:4:"area";s:0:"";s:10:"desc_trans";s:84:"Глубина поиска дочерних ресурсов от родителя.";s:10:"area_trans";s:0:"";}s:8:"forceXML";a:9:{s:4:"name";s:8:"forceXML";s:4:"desc";s:22:"polylang_prop_forceXML";s:4:"type";s:13:"combo-boolean";s:7:"options";a:0:{}s:5:"value";b:1;s:7:"lexicon";s:19:"polylang:properties";s:4:"area";s:0:"";s:10:"desc_trans";s:72:"Принудительно выводить страницу как xml.";s:10:"area_trans";s:0:"";}s:16:"hideUnsearchable";a:9:{s:4:"name";s:16:"hideUnsearchable";s:4:"desc";s:30:"polylang_prop_hideUnsearchable";s:4:"type";s:13:"combo-boolean";s:7:"options";a:0:{}s:5:"value";b:1;s:7:"lexicon";s:19:"polylang:properties";s:4:"area";s:0:"";s:10:"desc_trans";s:84:"Скрыть ресурсы, которые не участвуют в поиске.";s:10:"area_trans";s:0:"";}s:10:"includeTVs";a:9:{s:4:"name";s:10:"includeTVs";s:4:"desc";s:24:"polylang_prop_includeTVs";s:4:"type";s:9:"textfield";s:7:"options";a:0:{}s:5:"value";s:0:"";s:7:"lexicon";s:19:"polylang:properties";s:4:"area";s:0:"";s:10:"desc_trans";s:182:"Список ТВ параметров для выборки, через запятую. Например: "action,time" дадут плейсхолдеры [[+action]] и [[+time]].";s:10:"area_trans";s:0:"";}s:13:"languageGroup";a:9:{s:4:"name";s:13:"languageGroup";s:4:"desc";s:28:"polylang_prop_language_group";s:4:"type";s:9:"textfield";s:7:"options";a:0:{}s:5:"value";s:0:"";s:7:"lexicon";s:19:"polylang:properties";s:4:"area";s:0:"";s:10:"desc_trans";s:25:"Группа языков";s:10:"area_trans";s:0:"";}s:15:"outputSeparator";a:9:{s:4:"name";s:15:"outputSeparator";s:4:"desc";s:29:"polylang_prop_outputSeparator";s:4:"type";s:9:"textfield";s:7:"options";a:0:{}s:5:"value";s:0:"";s:7:"lexicon";s:19:"polylang:properties";s:4:"area";s:0:"";s:10:"desc_trans";s:106:"Необязательная строка для разделения результатов работы.";s:10:"area_trans";s:0:"";}s:7:"parents";a:9:{s:4:"name";s:7:"parents";s:4:"desc";s:21:"polylang_prop_parents";s:4:"type";s:9:"textfield";s:7:"options";a:0:{}s:5:"value";s:0:"";s:7:"lexicon";s:19:"polylang:properties";s:4:"area";s:0:"";s:10:"desc_trans";s:421:"Список родителей, через запятую, для поиска результатов. По умолчанию выборка ограничена текущим родителем. Если поставить 0 - выборка не ограничивается. Если id родителя начинается с дефиса, он и его потомки исключается из выборки.";s:10:"area_trans";s:0:"";}s:10:"prepareTVs";a:9:{s:4:"name";s:10:"prepareTVs";s:4:"desc";s:24:"polylang_prop_prepareTVs";s:4:"type";s:9:"textfield";s:7:"options";a:0:{}s:5:"value";s:1:"1";s:7:"lexicon";s:19:"polylang:properties";s:4:"area";s:0:"";s:10:"desc_trans";s:270:"Список ТВ параметров, которые нужно подготовить перед выводом. По умолчанию, установлено в "1", что означает подготовку всех ТВ, указанных в "&includeTVs=``"";s:10:"area_trans";s:0:"";}s:10:"processTVs";a:9:{s:4:"name";s:10:"processTVs";s:4:"desc";s:24:"polylang_prop_processTVs";s:4:"type";s:9:"textfield";s:7:"options";a:0:{}s:5:"value";s:0:"";s:7:"lexicon";s:19:"polylang:properties";s:4:"area";s:0:"";s:10:"desc_trans";s:288:"Список ТВ параметров, которые нужно обработать перед выводом. Если установить в "1" - будут обработаны все ТВ, указанные в "&includeTVs=``". По умолчанию параметр пуст.";s:10:"area_trans";s:0:"";}s:9:"resources";a:9:{s:4:"name";s:9:"resources";s:4:"desc";s:23:"polylang_prop_resources";s:4:"type";s:9:"textfield";s:7:"options";a:0:{}s:5:"value";s:0:"";s:7:"lexicon";s:19:"polylang:properties";s:4:"area";s:0:"";s:10:"desc_trans";s:235:"Список ресурсов, через запятую, для вывода в результатах. Если id ресурса начинается с дефиса, этот ресурс исключается из выборки.";s:10:"area_trans";s:0:"";}s:11:"showDeleted";a:9:{s:4:"name";s:11:"showDeleted";s:4:"desc";s:25:"polylang_prop_showDeleted";s:4:"type";s:13:"combo-boolean";s:7:"options";a:0:{}s:5:"value";b:0;s:7:"lexicon";s:19:"polylang:properties";s:4:"area";s:0:"";s:10:"desc_trans";s:55:"Показывать удалённые ресурсы.";s:10:"area_trans";s:0:"";}s:10:"showHidden";a:9:{s:4:"name";s:10:"showHidden";s:4:"desc";s:24:"polylang_prop_showHidden";s:4:"type";s:13:"combo-boolean";s:7:"options";a:0:{}s:5:"value";b:0;s:7:"lexicon";s:19:"polylang:properties";s:4:"area";s:0:"";s:10:"desc_trans";s:64:"Показывать ресурсы, скрытые в меню.";s:10:"area_trans";s:0:"";}s:15:"showUnpublished";a:9:{s:4:"name";s:15:"showUnpublished";s:4:"desc";s:29:"polylang_prop_showUnpublished";s:4:"type";s:13:"combo-boolean";s:7:"options";a:0:{}s:5:"value";b:0;s:7:"lexicon";s:19:"polylang:properties";s:4:"area";s:0:"";s:10:"desc_trans";s:69:"Показывать неопубликованные ресурсы.";s:10:"area_trans";s:0:"";}s:13:"sitemapSchema";a:9:{s:4:"name";s:13:"sitemapSchema";s:4:"desc";s:27:"polylang_prop_sitemapSchema";s:4:"type";s:9:"textfield";s:7:"options";a:0:{}s:5:"value";s:43:"http://www.sitemaps.org/schemas/sitemap/0.9";s:7:"lexicon";s:19:"polylang:properties";s:4:"area";s:0:"";s:10:"desc_trans";s:33:"Схема карты сайта.";s:10:"area_trans";s:0:"";}s:6:"sortby";a:9:{s:4:"name";s:6:"sortby";s:4:"desc";s:20:"polylang_prop_sortby";s:4:"type";s:9:"textfield";s:7:"options";a:0:{}s:5:"value";s:9:"menuindex";s:7:"lexicon";s:19:"polylang:properties";s:4:"area";s:0:"";s:10:"desc_trans";s:334:"Любое поле ресурса для сортировки, включая ТВ параметр, если он указан в параметре "includeTVs". Можно указывать JSON строку с массивом нескольких полей. Для случайно сортировки укажите "RAND()"";s:10:"area_trans";s:0:"";}s:7:"sortdir";a:9:{s:4:"name";s:7:"sortdir";s:4:"desc";s:21:"polylang_prop_sortdir";s:4:"type";s:9:"textfield";s:7:"options";a:0:{}s:5:"value";s:3:"asc";s:7:"lexicon";s:19:"polylang:properties";s:4:"area";s:0:"";s:10:"desc_trans";s:97:"Направление сортировки: по убыванию или возрастанию.";s:10:"area_trans";s:0:"";}s:9:"templates";a:9:{s:4:"name";s:9:"templates";s:4:"desc";s:23:"polylang_prop_templates";s:4:"type";s:9:"textfield";s:7:"options";a:0:{}s:5:"value";s:0:"";s:7:"lexicon";s:19:"polylang:properties";s:4:"area";s:0:"";s:10:"desc_trans";s:243:"Список шаблонов, через запятую, для фильтрации результатов. Если id шаблона начинается с дефиса, ресурсы с ним исключается из выборки.";s:10:"area_trans";s:0:"";}s:3:"tpl";a:9:{s:4:"name";s:3:"tpl";s:4:"desc";s:17:"polylang_prop_tpl";s:4:"type";s:9:"textfield";s:7:"options";a:0:{}s:5:"value";s:341:"@INLINE<url>{$.const.PHP_EOL}<loc>[[+url]]</loc>{foreach $langs as $key => $url}{$.const.PHP_EOL}<xhtml:link rel="alternate" hreflang="{$key}" href="{$url}"/>{/foreach}{$.const.PHP_EOL}<lastmod>[[+date]]</lastmod>{$.const.PHP_EOL}<changefreq>[[+update]]</changefreq> {$.const.PHP_EOL}<priority>[[+priority]]</priority>{$.const.PHP_EOL}</url>";s:7:"lexicon";s:19:"polylang:properties";s:4:"area";s:0:"";s:10:"desc_trans";s:192:"Имя чанка для оформления ресурса. Если не указан, то содержимое полей ресурса будет распечатано на экран.";s:10:"area_trans";s:0:"";}s:10:"tplWrapper";a:9:{s:4:"name";s:10:"tplWrapper";s:4:"desc";s:24:"polylang_prop_tplWrapper";s:4:"type";s:9:"textfield";s:7:"options";a:0:{}s:5:"value";s:201:"@INLINE <?xml version="1.0" encoding="[[++modx_charset]]"?>{$.const.PHP_EOL}<urlset xmlns="[[+schema]]" xmlns:xhtml="http://www.w3.org/1999/xhtml">{$.const.PHP_EOL}[[+output]]{$.const.PHP_EOL}</urlset>";s:7:"lexicon";s:19:"polylang:properties";s:4:"area";s:0:"";s:10:"desc_trans";s:154:"Чанк-обёртка, для заворачивания всех результатов. Понимает один плейсхолдер: [[+output]].";s:10:"area_trans";s:0:"";}s:13:"useWeblinkUrl";a:9:{s:4:"name";s:13:"useWeblinkUrl";s:4:"desc";s:27:"polylang_prop_useWeblinkUrl";s:4:"type";s:13:"combo-boolean";s:7:"options";a:0:{}s:5:"value";b:1;s:7:"lexicon";s:19:"polylang:properties";s:4:"area";s:0:"";s:10:"desc_trans";s:82:"Генерировать ссылку с учетом класса ресурса.";s:10:"area_trans";s:0:"";}s:5:"where";a:9:{s:4:"name";s:5:"where";s:4:"desc";s:19:"polylang_prop_where";s:4:"type";s:9:"textfield";s:7:"options";a:0:{}s:5:"value";s:0:"";s:7:"lexicon";s:19:"polylang:properties";s:4:"area";s:0:"";s:10:"desc_trans";s:116:"Массив дополнительных параметров выборки, закодированный в JSON.";s:10:"area_trans";s:0:"";}}'
static_file: core/components/polylang/elements/snippets/PolylangSitemap.snippet.php

-----

/**
 * Polylang
 * @package polylang
 * @var modX $modx
 * @var Polylang $polylang
 * @var PolylangTools $tools
 * @var pdoFetch $pdoFetch
 * @var array $scriptProperties
 * @var string $scheme
 */

$fqn = $modx->getOption('pdoFetch.class', null, 'pdotools.pdofetch', true);
$path = $modx->getOption('pdofetch_class_path', null, MODX_CORE_PATH . 'components/pdotools/model/', true);
if ($pdoClass = $modx->loadClass($fqn, $path, false, true)) {
    $pdoFetch = new $pdoClass($modx, $scriptProperties);
} else {
    return false;
}
$pdoFetch->addTime('pdoTools loaded');

$polylang = $modx->getService('polylang', 'Polylang');
$tools = $polylang->getTools();

// Default variables
if (empty($tpl)) {
    $tpl = "@INLINE \n<url>\n\t<loc>[[+url]]</loc>\n\t<lastmod>[[+date]]</lastmod>\n\t<changefreq>[[+update]]</changefreq>\n\t<priority>[[+priority]]</priority>\n</url>";
}
if (empty($tplWrapper)) {
    $tplWrapper = "@INLINE <?xml version=\"1.0\" encoding=\"[[++modx_charset]]\"\n<urlset xmlns=\"[[+schema]]\">\n[[+output]]\n</urlset>";
}
if (empty($sitemapSchema)) {
    $sitemapSchema = 'http://www.sitemaps.org/schemas/sitemap/0.9';
}
if (empty($outputSeparator)) {
    $outputSeparator = "\n";
}
if (empty($cacheKey)) {
    $scriptProperties['cacheKey'] = 'sitemap/' . substr(md5(json_encode($scriptProperties)), 0, 6);
}

// Convert parameters from GoogleSiteMap if exists
if (!empty($itemTpl)) {
    $tpl = $itemTpl;
}
if (!empty($containerTpl)) {
    $tplWrapper = $containerTpl;
}
if (!empty($allowedtemplates)) {
    $scriptProperties['templates'] = $allowedtemplates;
}
if (!empty($maxDepth)) {
    $scriptProperties['depth'] = $maxDepth;
}
if (isset($hideDeleted)) {
    $scriptProperties['showDeleted'] = !$hideDeleted;
}
if (isset($published)) {
    $scriptProperties['showUnpublished'] = !$published;
}
if (isset($searchable)) {
    $scriptProperties['showUnsearchable'] = !$searchable;
}
if (!empty($googleSchema)) {
    $sitemapSchema = $googleSchema;
}
if (!empty($excludeResources)) {
    $tmp = array_map('trim', explode(',', $excludeResources));
    foreach ($tmp as $v) {
        if (!empty($scriptProperties['resources'])) {
            $scriptProperties['resources'] .= ',-' . $v;
        } else {
            $scriptProperties['resources'] = '-' . $v;
        }
    }
}
if (!empty($excludeChildrenOf)) {
    $tmp = array_map('trim', explode(',', $excludeChildrenOf));
    foreach ($tmp as $v) {
        if (!empty($scriptProperties['parents'])) {
            $scriptProperties['parents'] .= ',-' . $v;
        } else {
            $scriptProperties['parents'] = '-' . $v;
        }
    }
}
if (!empty($startId)) {
    if (!empty($scriptProperties['parents'])) {
        $scriptProperties['parents'] .= ',' . $startId;
    } else {
        $scriptProperties['parents'] = $startId;
    }
}
if (!empty($sortBy)) {
    $scriptProperties['sortby'] = $sortBy;
}
if (!empty($sortDir)) {
    $scriptProperties['sortdir'] = $sortDir;
}
if (!empty($priorityTV)) {
    if (!empty($scriptProperties['includeTVs'])) {
        $scriptProperties['includeTVs'] .= ',' . $priorityTV;
    } else {
        $scriptProperties['includeTVs'] = $priorityTV;
    }
}
if (!empty($itemSeparator)) {
    $outputSeparator = $itemSeparator;
}

$class = 'modResource';
$where = array();
if (empty($showHidden)) {
    $where[] = array(
        $class . '.hidemenu' => 0,
        'OR:' . $class . '.class_key:IN' => array('Ticket', 'Article'),
    );
}
if (empty($context)) {
    $scriptProperties['context'] = $modx->context->key;
}

$select = array($class => 'id,editedon,createdon,context_key,class_key,uri');
if (!empty($useWeblinkUrl)) {
    $select[$class] .= ',content';
}
// Add custom parameters
foreach (array('where', 'select') as $v) {
    if (!empty($scriptProperties[$v])) {
        $tmp = $scriptProperties[$v];
        if (!is_array($tmp)) {
            $tmp = json_decode($tmp, true);
        }
        if (is_array($tmp)) {
            $$v = array_merge($$v, $tmp);
        }
    }
    unset($scriptProperties[$v]);
}
$pdoFetch->addTime('Conditions prepared');

// Default parameters
$default = array(
    'class' => $class,
    'where' => json_encode($where),
    'select' => json_encode($select),
    'sortby' => "{$class}.parent ASC, {$class}.menuindex",
    'sortdir' => 'ASC',
    'return' => 'data',
    'scheme' => 'full',
    'limit' => 0,
);
// Merge all properties and run!
$pdoFetch->addTime('Query parameters ready');
$pdoFetch->setConfig(array_merge($default, $scriptProperties), false);

if (!empty($cache)) {
    $data = $pdoFetch->getCache($scriptProperties);
}
$defaultLanguage = $tools->getDefaultLanguage();
if (empty($data)) {
    $now = time();
    $data = $urls = array();
    $rows = $pdoFetch->run();
    $defaultLanguageGroup = $modx->getOption('polylang_default_language_group');
    $languageUrls = $tools->getLanguageUrls(true, array(
        'languageGroup' => $defaultLanguageGroup,
        'withSlash' => false
    ));
    foreach ($rows as $row) {
        if (!empty($useWeblinkUrl) && $row['class_key'] == 'modWebLink') {
            $row['url'] = is_numeric(trim($row['content'], '[]~ '))
                ? $pdoFetch->makeUrl(intval(trim($row['content'], '[]~ ')), $row)
                : $row['content'];
        } else {
            $row['url'] = $pdoFetch->makeUrl($row['id'], $row);
        }

        $time = !empty($row['editedon'])
            ? $row['editedon']
            : $row['createdon'];
        $row['date'] = date('c', $time);

        $datediff = floor(($now - $time) / 86400);
        if ($datediff <= 1) {
            $row['priority'] = '1.0';
            $row['update'] = 'daily';
        } elseif (($datediff > 1) && ($datediff <= 7)) {
            $row['priority'] = '0.75';
            $row['update'] = 'weekly';
        } elseif (($datediff > 7) && ($datediff <= 30)) {
            $row['priority'] = '0.50';
            $row['update'] = 'weekly';
        } else {
            $row['priority'] = '0.25';
            $row['update'] = 'monthly';
        }
        if (!empty($priorityTV) && !empty($row[$priorityTV])) {
            $row['priority'] = $row[$priorityTV];
        }

        // Fix possible duplicates made by modWebLink
        if (!empty($urls[$row['url']])) {
            if ($urls[$row['url']] > $row['date']) {
                continue;
            }
        }
        $row['langs'] = array();
        $row['defaultLang'] = $defaultLanguage;
        if ($languageUrls) {
            foreach ($languageUrls as $url => $key) {
                if ($key == $defaultLanguage) {
                    $url = $row['url'];
                } else {
                    $url = preg_replace('/https?:\/\/[^\/]+/', $url, $row['url']);
                }
                $row['langs'][$key] = $url;
            }
        }
        $urls[$row['url']] = $row['date'];

        // Add item to output
        $data[$row['url']] = $pdoFetch->parseChunk($tpl, $row);
        if (strpos($data[$row['url']], '[[') !== false) {
            $modx->parser->processElementTags('', $data[$row['url']], true, true, '[[', ']]', array(), 10);
        }
    }
    $pdoFetch->addTime('Rows processed');
    if (!empty($cache)) {
        $pdoFetch->setCache($data, $scriptProperties);
    }
}

$output = implode($outputSeparator, $data);
$output = $pdoFetch->getChunk($tplWrapper, array(
    'schema' => $sitemapSchema,
    'output' => $output,
    'items' => $output,
    'defaultLang' => $defaultLanguage,
));
$pdoFetch->addTime('Rows wrapped');

if ($modx->user->hasSessionContext('mgr') && !empty($showLog)) {
    $output .= '<pre class="pdoSitemapLog">' . print_r($pdoFetch->getTime(), 1) . '</pre>';
}

if (!empty($forceXML)) {
    header("Content-Type:text/xml");
    @session_write_close();
    exit($output);
} else {
    return $output;
}